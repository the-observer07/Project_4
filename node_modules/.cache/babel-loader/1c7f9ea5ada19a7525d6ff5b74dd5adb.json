{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/regenerator/index.js\");\n\nvar _toConsumableArray = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/helpers/toConsumableArray.js\").default;\n\nvar _classCallCheck = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\n\nvar _createClass = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/helpers/createClass.js\").default;\n\nfunction _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n  var _e = undefined;\n\n  try {\n    for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {\n  try {\n    var info = gen[key](arg);\n    var value = info.value;\n  } catch (error) {\n    reject(error);\n    return;\n  }\n\n  if (info.done) {\n    resolve(value);\n  } else {\n    Promise.resolve(value).then(_next, _throw);\n  }\n}\n\nfunction _asyncToGenerator(fn) {\n  return function () {\n    var self = this,\n        args = arguments;\n    return new Promise(function (resolve, reject) {\n      var gen = fn.apply(self, args);\n\n      function _next(value) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value);\n      }\n\n      function _throw(err) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err);\n      }\n\n      _next(undefined);\n    });\n  };\n}\n\nvar Events, Group, IORedisConnection, RedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nRedisConnection = require(\"./RedisConnection\");\nIORedisConnection = require(\"./IORedisConnection\");\nScripts = require(\"./Scripts\");\n\nGroup = function () {\n  var Group = /*#__PURE__*/function () {\n    function Group() {\n      var limiterOptions = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      _classCallCheck(this, Group);\n\n      this.deleteKey = this.deleteKey.bind(this);\n      this.limiterOptions = limiterOptions;\n      parser.load(this.limiterOptions, this.defaults, this);\n      this.Events = new Events(this);\n      this.instances = {};\n      this.Bottleneck = require(\"./Bottleneck\");\n\n      this._startAutoCleanup();\n\n      this.sharedConnection = this.connection != null;\n\n      if (this.connection == null) {\n        if (this.limiterOptions.datastore === \"redis\") {\n          this.connection = new RedisConnection(Object.assign({}, this.limiterOptions, {\n            Events: this.Events\n          }));\n        } else if (this.limiterOptions.datastore === \"ioredis\") {\n          this.connection = new IORedisConnection(Object.assign({}, this.limiterOptions, {\n            Events: this.Events\n          }));\n        }\n      }\n    }\n\n    _createClass(Group, [{\n      key: \"key\",\n      value: function key() {\n        var _this4 = this;\n\n        var _key = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : \"\";\n\n        var ref;\n        return (ref = this.instances[_key]) != null ? ref : function () {\n          var limiter;\n          limiter = _this4.instances[_key] = new _this4.Bottleneck(Object.assign(_this4.limiterOptions, {\n            id: \"\".concat(_this4.id, \"-\").concat(_key),\n            timeout: _this4.timeout,\n            connection: _this4.connection\n          }));\n\n          _this4.Events.trigger(\"created\", limiter, _key);\n\n          return limiter;\n        }();\n      }\n    }, {\n      key: \"deleteKey\",\n      value: function deleteKey() {\n        var key = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : \"\";\n\n        var _this = this;\n\n        return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n          var deleted, instance;\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  instance = _this.instances[key];\n\n                  if (!_this.connection) {\n                    _context.next = 5;\n                    break;\n                  }\n\n                  _context.next = 4;\n                  return _this.connection.__runCommand__(['del'].concat(_toConsumableArray(Scripts.allKeys(\"\".concat(_this.id, \"-\").concat(key)))));\n\n                case 4:\n                  deleted = _context.sent;\n\n                case 5:\n                  if (!(instance != null)) {\n                    _context.next = 9;\n                    break;\n                  }\n\n                  delete _this.instances[key];\n                  _context.next = 9;\n                  return instance.disconnect();\n\n                case 9:\n                  return _context.abrupt(\"return\", instance != null || deleted > 0);\n\n                case 10:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        }))();\n      }\n    }, {\n      key: \"limiters\",\n      value: function limiters() {\n        var k, ref, results, v;\n        ref = this.instances;\n        results = [];\n\n        for (k in ref) {\n          v = ref[k];\n          results.push({\n            key: k,\n            limiter: v\n          });\n        }\n\n        return results;\n      }\n    }, {\n      key: \"keys\",\n      value: function keys() {\n        return Object.keys(this.instances);\n      }\n    }, {\n      key: \"clusterKeys\",\n      value: function clusterKeys() {\n        var _this2 = this;\n\n        return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n          var cursor, end, found, i, k, keys, len, next, start, _ref, _ref2;\n\n          return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  if (!(_this2.connection == null)) {\n                    _context2.next = 2;\n                    break;\n                  }\n\n                  return _context2.abrupt(\"return\", _this2.Promise.resolve(_this2.keys()));\n\n                case 2:\n                  keys = [];\n                  cursor = null;\n                  start = \"b_\".concat(_this2.id, \"-\").length;\n                  end = \"_settings\".length;\n\n                case 6:\n                  if (!(cursor !== 0)) {\n                    _context2.next = 17;\n                    break;\n                  }\n\n                  _context2.next = 9;\n                  return _this2.connection.__runCommand__([\"scan\", cursor != null ? cursor : 0, \"match\", \"b_\".concat(_this2.id, \"-*_settings\"), \"count\", 10000]);\n\n                case 9:\n                  _ref = _context2.sent;\n                  _ref2 = _slicedToArray(_ref, 2);\n                  next = _ref2[0];\n                  found = _ref2[1];\n                  cursor = ~~next;\n\n                  for (i = 0, len = found.length; i < len; i++) {\n                    k = found[i];\n                    keys.push(k.slice(start, -end));\n                  }\n\n                  _context2.next = 6;\n                  break;\n\n                case 17:\n                  return _context2.abrupt(\"return\", keys);\n\n                case 18:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          }, _callee2);\n        }))();\n      }\n    }, {\n      key: \"_startAutoCleanup\",\n      value: function _startAutoCleanup() {\n        var _this3 = this;\n\n        var base;\n        clearInterval(this.interval);\n        return typeof (base = this.interval = setInterval( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n          var e, k, ref, results, time, v;\n          return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n            while (1) {\n              switch (_context3.prev = _context3.next) {\n                case 0:\n                  time = Date.now();\n                  ref = _this3.instances;\n                  results = [];\n                  _context3.t0 = _regeneratorRuntime.keys(ref);\n\n                case 4:\n                  if ((_context3.t1 = _context3.t0()).done) {\n                    _context3.next = 23;\n                    break;\n                  }\n\n                  k = _context3.t1.value;\n                  v = ref[k];\n                  _context3.prev = 7;\n                  _context3.next = 10;\n                  return v._store.__groupCheck__(time);\n\n                case 10:\n                  if (!_context3.sent) {\n                    _context3.next = 14;\n                    break;\n                  }\n\n                  results.push(_this3.deleteKey(k));\n                  _context3.next = 15;\n                  break;\n\n                case 14:\n                  results.push(void 0);\n\n                case 15:\n                  _context3.next = 21;\n                  break;\n\n                case 17:\n                  _context3.prev = 17;\n                  _context3.t2 = _context3[\"catch\"](7);\n                  e = _context3.t2;\n                  results.push(v.Events.trigger(\"error\", e));\n\n                case 21:\n                  _context3.next = 4;\n                  break;\n\n                case 23:\n                  return _context3.abrupt(\"return\", results);\n\n                case 24:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }\n          }, _callee3, null, [[7, 17]]);\n        })), this.timeout / 2)).unref === \"function\" ? base.unref() : void 0;\n      }\n    }, {\n      key: \"updateSettings\",\n      value: function updateSettings() {\n        var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        parser.overwrite(options, this.defaults, this);\n        parser.overwrite(options, options, this.limiterOptions);\n\n        if (options.timeout != null) {\n          return this._startAutoCleanup();\n        }\n      }\n    }, {\n      key: \"disconnect\",\n      value: function disconnect() {\n        var flush = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n        var ref;\n\n        if (!this.sharedConnection) {\n          return (ref = this.connection) != null ? ref.disconnect(flush) : void 0;\n        }\n      }\n    }]);\n\n    return Group;\n  }();\n\n  ;\n  Group.prototype.defaults = {\n    timeout: 1000 * 60 * 5,\n    connection: null,\n    Promise: Promise,\n    id: \"group-key\"\n  };\n  return Group;\n}.call(void 0);\n\nmodule.exports = Group;","map":{"version":3,"sources":["/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/bottleneck/lib/Group.js"],"names":["_slicedToArray","arr","i","_arrayWithHoles","_iterableToArrayLimit","_nonIterableRest","TypeError","_arr","_n","_d","_e","undefined","_i","Symbol","iterator","_s","next","done","push","value","length","err","Array","isArray","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","error","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","Events","Group","IORedisConnection","RedisConnection","Scripts","parser","require","limiterOptions","deleteKey","bind","load","defaults","instances","Bottleneck","_startAutoCleanup","sharedConnection","connection","datastore","Object","assign","ref","limiter","id","timeout","trigger","_this","instance","__runCommand__","allKeys","deleted","disconnect","k","results","v","keys","_this2","cursor","start","end","_ref","_ref2","found","len","slice","_this3","base","clearInterval","interval","setInterval","time","Date","now","_store","__groupCheck__","e","unref","options","overwrite","flush","prototype","call","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nfunction _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nvar Events, Group, IORedisConnection, RedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nRedisConnection = require(\"./RedisConnection\");\nIORedisConnection = require(\"./IORedisConnection\");\nScripts = require(\"./Scripts\");\n\nGroup = function () {\n  class Group {\n    constructor(limiterOptions = {}) {\n      this.deleteKey = this.deleteKey.bind(this);\n      this.limiterOptions = limiterOptions;\n      parser.load(this.limiterOptions, this.defaults, this);\n      this.Events = new Events(this);\n      this.instances = {};\n      this.Bottleneck = require(\"./Bottleneck\");\n\n      this._startAutoCleanup();\n\n      this.sharedConnection = this.connection != null;\n\n      if (this.connection == null) {\n        if (this.limiterOptions.datastore === \"redis\") {\n          this.connection = new RedisConnection(Object.assign({}, this.limiterOptions, {\n            Events: this.Events\n          }));\n        } else if (this.limiterOptions.datastore === \"ioredis\") {\n          this.connection = new IORedisConnection(Object.assign({}, this.limiterOptions, {\n            Events: this.Events\n          }));\n        }\n      }\n    }\n\n    key(key = \"\") {\n      var ref;\n      return (ref = this.instances[key]) != null ? ref : (() => {\n        var limiter;\n        limiter = this.instances[key] = new this.Bottleneck(Object.assign(this.limiterOptions, {\n          id: `${this.id}-${key}`,\n          timeout: this.timeout,\n          connection: this.connection\n        }));\n        this.Events.trigger(\"created\", limiter, key);\n        return limiter;\n      })();\n    }\n\n    deleteKey(key = \"\") {\n      var _this = this;\n\n      return _asyncToGenerator(function* () {\n        var deleted, instance;\n        instance = _this.instances[key];\n\n        if (_this.connection) {\n          deleted = yield _this.connection.__runCommand__(['del', ...Scripts.allKeys(`${_this.id}-${key}`)]);\n        }\n\n        if (instance != null) {\n          delete _this.instances[key];\n          yield instance.disconnect();\n        }\n\n        return instance != null || deleted > 0;\n      })();\n    }\n\n    limiters() {\n      var k, ref, results, v;\n      ref = this.instances;\n      results = [];\n\n      for (k in ref) {\n        v = ref[k];\n        results.push({\n          key: k,\n          limiter: v\n        });\n      }\n\n      return results;\n    }\n\n    keys() {\n      return Object.keys(this.instances);\n    }\n\n    clusterKeys() {\n      var _this2 = this;\n\n      return _asyncToGenerator(function* () {\n        var cursor, end, found, i, k, keys, len, next, start;\n\n        if (_this2.connection == null) {\n          return _this2.Promise.resolve(_this2.keys());\n        }\n\n        keys = [];\n        cursor = null;\n        start = `b_${_this2.id}-`.length;\n        end = \"_settings\".length;\n\n        while (cursor !== 0) {\n          var _ref = yield _this2.connection.__runCommand__([\"scan\", cursor != null ? cursor : 0, \"match\", `b_${_this2.id}-*_settings`, \"count\", 10000]);\n\n          var _ref2 = _slicedToArray(_ref, 2);\n\n          next = _ref2[0];\n          found = _ref2[1];\n          cursor = ~~next;\n\n          for (i = 0, len = found.length; i < len; i++) {\n            k = found[i];\n            keys.push(k.slice(start, -end));\n          }\n        }\n\n        return keys;\n      })();\n    }\n\n    _startAutoCleanup() {\n      var _this3 = this;\n\n      var base;\n      clearInterval(this.interval);\n      return typeof (base = this.interval = setInterval(\n      /*#__PURE__*/\n      _asyncToGenerator(function* () {\n        var e, k, ref, results, time, v;\n        time = Date.now();\n        ref = _this3.instances;\n        results = [];\n\n        for (k in ref) {\n          v = ref[k];\n\n          try {\n            if (yield v._store.__groupCheck__(time)) {\n              results.push(_this3.deleteKey(k));\n            } else {\n              results.push(void 0);\n            }\n          } catch (error) {\n            e = error;\n            results.push(v.Events.trigger(\"error\", e));\n          }\n        }\n\n        return results;\n      }), this.timeout / 2)).unref === \"function\" ? base.unref() : void 0;\n    }\n\n    updateSettings(options = {}) {\n      parser.overwrite(options, this.defaults, this);\n      parser.overwrite(options, options, this.limiterOptions);\n\n      if (options.timeout != null) {\n        return this._startAutoCleanup();\n      }\n    }\n\n    disconnect(flush = true) {\n      var ref;\n\n      if (!this.sharedConnection) {\n        return (ref = this.connection) != null ? ref.disconnect(flush) : void 0;\n      }\n    }\n\n  }\n\n  ;\n  Group.prototype.defaults = {\n    timeout: 1000 * 60 * 5,\n    connection: null,\n    Promise: Promise,\n    id: \"group-key\"\n  };\n  return Group;\n}.call(void 0);\n\nmodule.exports = Group;"]},"metadata":{},"sourceType":"script"}