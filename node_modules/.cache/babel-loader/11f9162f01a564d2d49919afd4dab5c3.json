{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/regenerator/index.js\");\n\nvar _classCallCheck = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\n\nvar _createClass = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/helpers/createClass.js\").default;\n\nfunction _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n  var _e = undefined;\n\n  try {\n    for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {\n  try {\n    var info = gen[key](arg);\n    var value = info.value;\n  } catch (error) {\n    reject(error);\n    return;\n  }\n\n  if (info.done) {\n    resolve(value);\n  } else {\n    Promise.resolve(value).then(_next, _throw);\n  }\n}\n\nfunction _asyncToGenerator(fn) {\n  return function () {\n    var self = this,\n        args = arguments;\n    return new Promise(function (resolve, reject) {\n      var gen = fn.apply(self, args);\n\n      function _next(value) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value);\n      }\n\n      function _throw(err) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err);\n      }\n\n      _next(undefined);\n    });\n  };\n}\n\nvar Events, IORedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nScripts = require(\"./Scripts\");\n\nIORedisConnection = function () {\n  var IORedisConnection = /*#__PURE__*/function () {\n    function IORedisConnection() {\n      var _this3 = this;\n\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      _classCallCheck(this, IORedisConnection);\n\n      parser.load(options, this.defaults, this);\n\n      if (this.Redis == null) {\n        this.Redis = eval(\"require\")(\"ioredis\"); // Obfuscated or else Webpack/Angular will try to inline the optional ioredis module. To override this behavior: pass the ioredis module to Bottleneck as the 'Redis' option.\n      }\n\n      if (this.Events == null) {\n        this.Events = new Events(this);\n      }\n\n      this.terminated = false;\n\n      if (this.clusterNodes != null) {\n        this.client = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n        this.subscriber = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n      } else if (this.client != null && this.client.duplicate == null) {\n        this.subscriber = new this.Redis.Cluster(this.client.startupNodes, this.client.options);\n      } else {\n        if (this.client == null) {\n          this.client = new this.Redis(this.clientOptions);\n        }\n\n        this.subscriber = this.client.duplicate();\n      }\n\n      this.limiters = {};\n      this.ready = this.Promise.all([this._setup(this.client, false), this._setup(this.subscriber, true)]).then(function () {\n        _this3._loadScripts();\n\n        return {\n          client: _this3.client,\n          subscriber: _this3.subscriber\n        };\n      });\n    }\n\n    _createClass(IORedisConnection, [{\n      key: \"_setup\",\n      value: function _setup(client, sub) {\n        var _this4 = this;\n\n        client.setMaxListeners(0);\n        return new this.Promise(function (resolve, reject) {\n          client.on(\"error\", function (e) {\n            return _this4.Events.trigger(\"error\", e);\n          });\n\n          if (sub) {\n            client.on(\"message\", function (channel, message) {\n              var ref;\n              return (ref = _this4.limiters[channel]) != null ? ref._store.onMessage(channel, message) : void 0;\n            });\n          }\n\n          if (client.status === \"ready\") {\n            return resolve();\n          } else {\n            return client.once(\"ready\", resolve);\n          }\n        });\n      }\n    }, {\n      key: \"_loadScripts\",\n      value: function _loadScripts() {\n        var _this5 = this;\n\n        return Scripts.names.forEach(function (name) {\n          return _this5.client.defineCommand(name, {\n            lua: Scripts.payload(name)\n          });\n        });\n      }\n    }, {\n      key: \"__runCommand__\",\n      value: function __runCommand__(cmd) {\n        var _this = this;\n\n        return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n          var _, deleted, _ref, _ref2, _ref2$;\n\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  _context.next = 2;\n                  return _this.ready;\n\n                case 2:\n                  _context.next = 4;\n                  return _this.client.pipeline([cmd]).exec();\n\n                case 4:\n                  _ref = _context.sent;\n                  _ref2 = _slicedToArray(_ref, 1);\n                  _ref2$ = _slicedToArray(_ref2[0], 2);\n                  _ = _ref2$[0];\n                  deleted = _ref2$[1];\n                  return _context.abrupt(\"return\", deleted);\n\n                case 10:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        }))();\n      }\n    }, {\n      key: \"__addLimiter__\",\n      value: function __addLimiter__(instance) {\n        var _this6 = this;\n\n        return this.Promise.all([instance.channel(), instance.channel_client()].map(function (channel) {\n          return new _this6.Promise(function (resolve, reject) {\n            return _this6.subscriber.subscribe(channel, function () {\n              _this6.limiters[channel] = instance;\n              return resolve();\n            });\n          });\n        }));\n      }\n    }, {\n      key: \"__removeLimiter__\",\n      value: function __removeLimiter__(instance) {\n        var _this2 = this;\n\n        return [instance.channel(), instance.channel_client()].forEach( /*#__PURE__*/function () {\n          var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(channel) {\n            return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n              while (1) {\n                switch (_context2.prev = _context2.next) {\n                  case 0:\n                    if (_this2.terminated) {\n                      _context2.next = 3;\n                      break;\n                    }\n\n                    _context2.next = 3;\n                    return _this2.subscriber.unsubscribe(channel);\n\n                  case 3:\n                    return _context2.abrupt(\"return\", delete _this2.limiters[channel]);\n\n                  case 4:\n                  case \"end\":\n                    return _context2.stop();\n                }\n              }\n            }, _callee2);\n          }));\n\n          return function (_x) {\n            return _ref3.apply(this, arguments);\n          };\n        }());\n      }\n    }, {\n      key: \"__scriptArgs__\",\n      value: function __scriptArgs__(name, id, args, cb) {\n        var keys;\n        keys = Scripts.keys(name, id);\n        return [keys.length].concat(keys, args, cb);\n      }\n    }, {\n      key: \"__scriptFn__\",\n      value: function __scriptFn__(name) {\n        return this.client[name].bind(this.client);\n      }\n    }, {\n      key: \"disconnect\",\n      value: function disconnect() {\n        var flush = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n        var i, k, len, ref;\n        ref = Object.keys(this.limiters);\n\n        for (i = 0, len = ref.length; i < len; i++) {\n          k = ref[i];\n          clearInterval(this.limiters[k]._store.heartbeat);\n        }\n\n        this.limiters = {};\n        this.terminated = true;\n\n        if (flush) {\n          return this.Promise.all([this.client.quit(), this.subscriber.quit()]);\n        } else {\n          this.client.disconnect();\n          this.subscriber.disconnect();\n          return this.Promise.resolve();\n        }\n      }\n    }]);\n\n    return IORedisConnection;\n  }();\n\n  ;\n  IORedisConnection.prototype.datastore = \"ioredis\";\n  IORedisConnection.prototype.defaults = {\n    Redis: null,\n    clientOptions: {},\n    clusterNodes: null,\n    client: null,\n    Promise: Promise,\n    Events: null\n  };\n  return IORedisConnection;\n}.call(void 0);\n\nmodule.exports = IORedisConnection;","map":{"version":3,"sources":["/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/bottleneck/lib/IORedisConnection.js"],"names":["_slicedToArray","arr","i","_arrayWithHoles","_iterableToArrayLimit","_nonIterableRest","TypeError","_arr","_n","_d","_e","undefined","_i","Symbol","iterator","_s","next","done","push","value","length","err","Array","isArray","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","error","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","Events","IORedisConnection","Scripts","parser","require","options","load","defaults","Redis","eval","terminated","clusterNodes","client","Cluster","clientOptions","subscriber","duplicate","startupNodes","limiters","ready","all","_setup","_loadScripts","sub","setMaxListeners","on","e","trigger","channel","message","ref","_store","onMessage","status","once","names","forEach","name","defineCommand","lua","payload","cmd","_this","pipeline","exec","_ref","_ref2","_ref2$","_","deleted","instance","channel_client","map","subscribe","_this2","_ref3","unsubscribe","_x","id","cb","keys","concat","bind","flush","k","len","Object","clearInterval","heartbeat","quit","disconnect","prototype","datastore","call","module","exports"],"mappings":"AAAA;;;;;;;;AAEA,SAASA,cAAT,CAAwBC,GAAxB,EAA6BC,CAA7B,EAAgC;AAAE,SAAOC,eAAe,CAACF,GAAD,CAAf,IAAwBG,qBAAqB,CAACH,GAAD,EAAMC,CAAN,CAA7C,IAAyDG,gBAAgB,EAAhF;AAAqF;;AAEvH,SAASA,gBAAT,GAA4B;AAAE,QAAM,IAAIC,SAAJ,CAAc,sDAAd,CAAN;AAA8E;;AAE5G,SAASF,qBAAT,CAA+BH,GAA/B,EAAoCC,CAApC,EAAuC;AAAE,MAAIK,IAAI,GAAG,EAAX;AAAe,MAAIC,EAAE,GAAG,IAAT;AAAe,MAAIC,EAAE,GAAG,KAAT;AAAgB,MAAIC,EAAE,GAAGC,SAAT;;AAAoB,MAAI;AAAE,SAAK,IAAIC,EAAE,GAAGX,GAAG,CAACY,MAAM,CAACC,QAAR,CAAH,EAAT,EAAiCC,EAAtC,EAA0C,EAAEP,EAAE,GAAG,CAACO,EAAE,GAAGH,EAAE,CAACI,IAAH,EAAN,EAAiBC,IAAxB,CAA1C,EAAyET,EAAE,GAAG,IAA9E,EAAoF;AAAED,MAAAA,IAAI,CAACW,IAAL,CAAUH,EAAE,CAACI,KAAb;;AAAqB,UAAIjB,CAAC,IAAIK,IAAI,CAACa,MAAL,KAAgBlB,CAAzB,EAA4B;AAAQ;AAAE,GAAvJ,CAAwJ,OAAOmB,GAAP,EAAY;AAAEZ,IAAAA,EAAE,GAAG,IAAL;AAAWC,IAAAA,EAAE,GAAGW,GAAL;AAAW,GAA5L,SAAqM;AAAE,QAAI;AAAE,UAAI,CAACb,EAAD,IAAOI,EAAE,CAAC,QAAD,CAAF,IAAgB,IAA3B,EAAiCA,EAAE,CAAC,QAAD,CAAF;AAAiB,KAAxD,SAAiE;AAAE,UAAIH,EAAJ,EAAQ,MAAMC,EAAN;AAAW;AAAE;;AAAC,SAAOH,IAAP;AAAc;;AAEzZ,SAASJ,eAAT,CAAyBF,GAAzB,EAA8B;AAAE,MAAIqB,KAAK,CAACC,OAAN,CAActB,GAAd,CAAJ,EAAwB,OAAOA,GAAP;AAAa;;AAErE,SAASuB,kBAAT,CAA4BC,GAA5B,EAAiCC,OAAjC,EAA0CC,MAA1C,EAAkDC,KAAlD,EAAyDC,MAAzD,EAAiEC,GAAjE,EAAsEC,GAAtE,EAA2E;AAAE,MAAI;AAAE,QAAIC,IAAI,GAAGP,GAAG,CAACK,GAAD,CAAH,CAASC,GAAT,CAAX;AAA0B,QAAIZ,KAAK,GAAGa,IAAI,CAACb,KAAjB;AAAyB,GAAzD,CAA0D,OAAOc,KAAP,EAAc;AAAEN,IAAAA,MAAM,CAACM,KAAD,CAAN;AAAe;AAAS;;AAAC,MAAID,IAAI,CAACf,IAAT,EAAe;AAAES,IAAAA,OAAO,CAACP,KAAD,CAAP;AAAiB,GAAlC,MAAwC;AAAEe,IAAAA,OAAO,CAACR,OAAR,CAAgBP,KAAhB,EAAuBgB,IAAvB,CAA4BP,KAA5B,EAAmCC,MAAnC;AAA6C;AAAE;;AAEzQ,SAASO,iBAAT,CAA2BC,EAA3B,EAA+B;AAAE,SAAO,YAAY;AAAE,QAAIC,IAAI,GAAG,IAAX;AAAA,QAAiBC,IAAI,GAAGC,SAAxB;AAAmC,WAAO,IAAIN,OAAJ,CAAY,UAAUR,OAAV,EAAmBC,MAAnB,EAA2B;AAAE,UAAIF,GAAG,GAAGY,EAAE,CAACI,KAAH,CAASH,IAAT,EAAeC,IAAf,CAAV;;AAAgC,eAASX,KAAT,CAAeT,KAAf,EAAsB;AAAEK,QAAAA,kBAAkB,CAACC,GAAD,EAAMC,OAAN,EAAeC,MAAf,EAAuBC,KAAvB,EAA8BC,MAA9B,EAAsC,MAAtC,EAA8CV,KAA9C,CAAlB;AAAyE;;AAAC,eAASU,MAAT,CAAgBR,GAAhB,EAAqB;AAAEG,QAAAA,kBAAkB,CAACC,GAAD,EAAMC,OAAN,EAAeC,MAAf,EAAuBC,KAAvB,EAA8BC,MAA9B,EAAsC,OAAtC,EAA+CR,GAA/C,CAAlB;AAAwE;;AAACO,MAAAA,KAAK,CAACjB,SAAD,CAAL;AAAmB,KAA9R,CAAP;AAAyS,GAAjW;AAAoW;;AAErY,IAAI+B,MAAJ,EAAYC,iBAAZ,EAA+BC,OAA/B,EAAwCC,MAAxC;AACAA,MAAM,GAAGC,OAAO,CAAC,UAAD,CAAhB;AACAJ,MAAM,GAAGI,OAAO,CAAC,UAAD,CAAhB;AACAF,OAAO,GAAGE,OAAO,CAAC,WAAD,CAAjB;;AAEAH,iBAAiB,GAAG,YAAY;AAAA,MACxBA,iBADwB;AAE5B,iCAA0B;AAAA;;AAAA,UAAdI,OAAc,uEAAJ,EAAI;;AAAA;;AACxBF,MAAAA,MAAM,CAACG,IAAP,CAAYD,OAAZ,EAAqB,KAAKE,QAA1B,EAAoC,IAApC;;AAEA,UAAI,KAAKC,KAAL,IAAc,IAAlB,EAAwB;AACtB,aAAKA,KAAL,GAAaC,IAAI,CAAC,SAAD,CAAJ,CAAgB,SAAhB,CAAb,CADsB,CACmB;AAC1C;;AAED,UAAI,KAAKT,MAAL,IAAe,IAAnB,EAAyB;AACvB,aAAKA,MAAL,GAAc,IAAIA,MAAJ,CAAW,IAAX,CAAd;AACD;;AAED,WAAKU,UAAL,GAAkB,KAAlB;;AAEA,UAAI,KAAKC,YAAL,IAAqB,IAAzB,EAA+B;AAC7B,aAAKC,MAAL,GAAc,IAAI,KAAKJ,KAAL,CAAWK,OAAf,CAAuB,KAAKF,YAA5B,EAA0C,KAAKG,aAA/C,CAAd;AACA,aAAKC,UAAL,GAAkB,IAAI,KAAKP,KAAL,CAAWK,OAAf,CAAuB,KAAKF,YAA5B,EAA0C,KAAKG,aAA/C,CAAlB;AACD,OAHD,MAGO,IAAI,KAAKF,MAAL,IAAe,IAAf,IAAuB,KAAKA,MAAL,CAAYI,SAAZ,IAAyB,IAApD,EAA0D;AAC/D,aAAKD,UAAL,GAAkB,IAAI,KAAKP,KAAL,CAAWK,OAAf,CAAuB,KAAKD,MAAL,CAAYK,YAAnC,EAAiD,KAAKL,MAAL,CAAYP,OAA7D,CAAlB;AACD,OAFM,MAEA;AACL,YAAI,KAAKO,MAAL,IAAe,IAAnB,EAAyB;AACvB,eAAKA,MAAL,GAAc,IAAI,KAAKJ,KAAT,CAAe,KAAKM,aAApB,CAAd;AACD;;AAED,aAAKC,UAAL,GAAkB,KAAKH,MAAL,CAAYI,SAAZ,EAAlB;AACD;;AAED,WAAKE,QAAL,GAAgB,EAAhB;AACA,WAAKC,KAAL,GAAa,KAAK3B,OAAL,CAAa4B,GAAb,CAAiB,CAAC,KAAKC,MAAL,CAAY,KAAKT,MAAjB,EAAyB,KAAzB,CAAD,EAAkC,KAAKS,MAAL,CAAY,KAAKN,UAAjB,EAA6B,IAA7B,CAAlC,CAAjB,EAAwFtB,IAAxF,CAA6F,YAAM;AAC9G,QAAA,MAAI,CAAC6B,YAAL;;AAEA,eAAO;AACLV,UAAAA,MAAM,EAAE,MAAI,CAACA,MADR;AAELG,UAAAA,UAAU,EAAE,MAAI,CAACA;AAFZ,SAAP;AAID,OAPY,CAAb;AAQD;;AArC2B;AAAA;AAAA,aAuC5B,gBAAOH,MAAP,EAAeW,GAAf,EAAoB;AAAA;;AAClBX,QAAAA,MAAM,CAACY,eAAP,CAAuB,CAAvB;AACA,eAAO,IAAI,KAAKhC,OAAT,CAAiB,UAACR,OAAD,EAAUC,MAAV,EAAqB;AAC3C2B,UAAAA,MAAM,CAACa,EAAP,CAAU,OAAV,EAAmB,UAAAC,CAAC,EAAI;AACtB,mBAAO,MAAI,CAAC1B,MAAL,CAAY2B,OAAZ,CAAoB,OAApB,EAA6BD,CAA7B,CAAP;AACD,WAFD;;AAIA,cAAIH,GAAJ,EAAS;AACPX,YAAAA,MAAM,CAACa,EAAP,CAAU,SAAV,EAAqB,UAACG,OAAD,EAAUC,OAAV,EAAsB;AACzC,kBAAIC,GAAJ;AACA,qBAAO,CAACA,GAAG,GAAG,MAAI,CAACZ,QAAL,CAAcU,OAAd,CAAP,KAAkC,IAAlC,GAAyCE,GAAG,CAACC,MAAJ,CAAWC,SAAX,CAAqBJ,OAArB,EAA8BC,OAA9B,CAAzC,GAAkF,KAAK,CAA9F;AACD,aAHD;AAID;;AAED,cAAIjB,MAAM,CAACqB,MAAP,KAAkB,OAAtB,EAA+B;AAC7B,mBAAOjD,OAAO,EAAd;AACD,WAFD,MAEO;AACL,mBAAO4B,MAAM,CAACsB,IAAP,CAAY,OAAZ,EAAqBlD,OAArB,CAAP;AACD;AACF,SAjBM,CAAP;AAkBD;AA3D2B;AAAA;AAAA,aA6D5B,wBAAe;AAAA;;AACb,eAAOkB,OAAO,CAACiC,KAAR,CAAcC,OAAd,CAAsB,UAAAC,IAAI,EAAI;AACnC,iBAAO,MAAI,CAACzB,MAAL,CAAY0B,aAAZ,CAA0BD,IAA1B,EAAgC;AACrCE,YAAAA,GAAG,EAAErC,OAAO,CAACsC,OAAR,CAAgBH,IAAhB;AADgC,WAAhC,CAAP;AAGD,SAJM,CAAP;AAKD;AAnE2B;AAAA;AAAA,aAqE5B,wBAAeI,GAAf,EAAoB;AAClB,YAAIC,KAAK,GAAG,IAAZ;;AAEA,eAAOhD,iBAAiB,wCAAC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAGvB,yBAAMgD,KAAK,CAACvB,KAAZ;;AAHuB;AAAA;AAKZ,yBAAMuB,KAAK,CAAC9B,MAAN,CAAa+B,QAAb,CAAsB,CAACF,GAAD,CAAtB,EAA6BG,IAA7B,EAAN;;AALY;AAKnBC,kBAAAA,IALmB;AAOnBC,kBAAAA,KAPmB,GAOXxF,cAAc,CAACuF,IAAD,EAAO,CAAP,CAPH;AASnBE,kBAAAA,MATmB,GASVzF,cAAc,CAACwF,KAAK,CAAC,CAAD,CAAN,EAAW,CAAX,CATJ;AAWvBE,kBAAAA,CAAC,GAAGD,MAAM,CAAC,CAAD,CAAV;AACAE,kBAAAA,OAAO,GAAGF,MAAM,CAAC,CAAD,CAAhB;AAZuB,mDAahBE,OAbgB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAD,EAAjB,EAAP;AAeD;AAvF2B;AAAA;AAAA,aAyF5B,wBAAeC,QAAf,EAAyB;AAAA;;AACvB,eAAO,KAAK1D,OAAL,CAAa4B,GAAb,CAAiB,CAAC8B,QAAQ,CAACtB,OAAT,EAAD,EAAqBsB,QAAQ,CAACC,cAAT,EAArB,EAAgDC,GAAhD,CAAoD,UAAAxB,OAAO,EAAI;AACrF,iBAAO,IAAI,MAAI,CAACpC,OAAT,CAAiB,UAACR,OAAD,EAAUC,MAAV,EAAqB;AAC3C,mBAAO,MAAI,CAAC8B,UAAL,CAAgBsC,SAAhB,CAA0BzB,OAA1B,EAAmC,YAAM;AAC9C,cAAA,MAAI,CAACV,QAAL,CAAcU,OAAd,IAAyBsB,QAAzB;AACA,qBAAOlE,OAAO,EAAd;AACD,aAHM,CAAP;AAID,WALM,CAAP;AAMD,SAPuB,CAAjB,CAAP;AAQD;AAlG2B;AAAA;AAAA,aAoG5B,2BAAkBkE,QAAlB,EAA4B;AAC1B,YAAII,MAAM,GAAG,IAAb;;AAEA,eAAO,CAACJ,QAAQ,CAACtB,OAAT,EAAD,EAAqBsB,QAAQ,CAACC,cAAT,EAArB,EAAgDf,OAAhD,EACP,aACA,YAAY;AACV,cAAImB,KAAK,GAAG7D,iBAAiB,wCAAC,kBAAWkC,OAAX;AAAA;AAAA;AAAA;AAAA;AAAA,wBACvB0B,MAAM,CAAC5C,UADgB;AAAA;AAAA;AAAA;;AAAA;AAE1B,2BAAM4C,MAAM,CAACvC,UAAP,CAAkByC,WAAlB,CAA8B5B,OAA9B,CAAN;;AAF0B;AAAA,sDAKrB,OAAO0B,MAAM,CAACpC,QAAP,CAAgBU,OAAhB,CALc;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAAD,EAA7B;;AAQA,iBAAO,UAAU6B,EAAV,EAAc;AACnB,mBAAOF,KAAK,CAACxD,KAAN,CAAY,IAAZ,EAAkBD,SAAlB,CAAP;AACD,WAFD;AAGD,SAZD,EAFO,CAAP;AAeD;AAtH2B;AAAA;AAAA,aAwH5B,wBAAeuC,IAAf,EAAqBqB,EAArB,EAAyB7D,IAAzB,EAA+B8D,EAA/B,EAAmC;AACjC,YAAIC,IAAJ;AACAA,QAAAA,IAAI,GAAG1D,OAAO,CAAC0D,IAAR,CAAavB,IAAb,EAAmBqB,EAAnB,CAAP;AACA,eAAO,CAACE,IAAI,CAAClF,MAAN,EAAcmF,MAAd,CAAqBD,IAArB,EAA2B/D,IAA3B,EAAiC8D,EAAjC,CAAP;AACD;AA5H2B;AAAA;AAAA,aA8H5B,sBAAatB,IAAb,EAAmB;AACjB,eAAO,KAAKzB,MAAL,CAAYyB,IAAZ,EAAkByB,IAAlB,CAAuB,KAAKlD,MAA5B,CAAP;AACD;AAhI2B;AAAA;AAAA,aAkI5B,sBAAyB;AAAA,YAAdmD,KAAc,uEAAN,IAAM;AACvB,YAAIvG,CAAJ,EAAOwG,CAAP,EAAUC,GAAV,EAAenC,GAAf;AACAA,QAAAA,GAAG,GAAGoC,MAAM,CAACN,IAAP,CAAY,KAAK1C,QAAjB,CAAN;;AAEA,aAAK1D,CAAC,GAAG,CAAJ,EAAOyG,GAAG,GAAGnC,GAAG,CAACpD,MAAtB,EAA8BlB,CAAC,GAAGyG,GAAlC,EAAuCzG,CAAC,EAAxC,EAA4C;AAC1CwG,UAAAA,CAAC,GAAGlC,GAAG,CAACtE,CAAD,CAAP;AACA2G,UAAAA,aAAa,CAAC,KAAKjD,QAAL,CAAc8C,CAAd,EAAiBjC,MAAjB,CAAwBqC,SAAzB,CAAb;AACD;;AAED,aAAKlD,QAAL,GAAgB,EAAhB;AACA,aAAKR,UAAL,GAAkB,IAAlB;;AAEA,YAAIqD,KAAJ,EAAW;AACT,iBAAO,KAAKvE,OAAL,CAAa4B,GAAb,CAAiB,CAAC,KAAKR,MAAL,CAAYyD,IAAZ,EAAD,EAAqB,KAAKtD,UAAL,CAAgBsD,IAAhB,EAArB,CAAjB,CAAP;AACD,SAFD,MAEO;AACL,eAAKzD,MAAL,CAAY0D,UAAZ;AACA,eAAKvD,UAAL,CAAgBuD,UAAhB;AACA,iBAAO,KAAK9E,OAAL,CAAaR,OAAb,EAAP;AACD;AACF;AArJ2B;;AAAA;AAAA;;AAyJ9B;AACAiB,EAAAA,iBAAiB,CAACsE,SAAlB,CAA4BC,SAA5B,GAAwC,SAAxC;AACAvE,EAAAA,iBAAiB,CAACsE,SAAlB,CAA4BhE,QAA5B,GAAuC;AACrCC,IAAAA,KAAK,EAAE,IAD8B;AAErCM,IAAAA,aAAa,EAAE,EAFsB;AAGrCH,IAAAA,YAAY,EAAE,IAHuB;AAIrCC,IAAAA,MAAM,EAAE,IAJ6B;AAKrCpB,IAAAA,OAAO,EAAEA,OAL4B;AAMrCQ,IAAAA,MAAM,EAAE;AAN6B,GAAvC;AAQA,SAAOC,iBAAP;AACD,CApKmB,CAoKlBwE,IApKkB,CAoKb,KAAK,CApKQ,CAApB;;AAsKAC,MAAM,CAACC,OAAP,GAAiB1E,iBAAjB","sourcesContent":["\"use strict\";\n\nfunction _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nvar Events, IORedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nScripts = require(\"./Scripts\");\n\nIORedisConnection = function () {\n  class IORedisConnection {\n    constructor(options = {}) {\n      parser.load(options, this.defaults, this);\n\n      if (this.Redis == null) {\n        this.Redis = eval(\"require\")(\"ioredis\"); // Obfuscated or else Webpack/Angular will try to inline the optional ioredis module. To override this behavior: pass the ioredis module to Bottleneck as the 'Redis' option.\n      }\n\n      if (this.Events == null) {\n        this.Events = new Events(this);\n      }\n\n      this.terminated = false;\n\n      if (this.clusterNodes != null) {\n        this.client = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n        this.subscriber = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n      } else if (this.client != null && this.client.duplicate == null) {\n        this.subscriber = new this.Redis.Cluster(this.client.startupNodes, this.client.options);\n      } else {\n        if (this.client == null) {\n          this.client = new this.Redis(this.clientOptions);\n        }\n\n        this.subscriber = this.client.duplicate();\n      }\n\n      this.limiters = {};\n      this.ready = this.Promise.all([this._setup(this.client, false), this._setup(this.subscriber, true)]).then(() => {\n        this._loadScripts();\n\n        return {\n          client: this.client,\n          subscriber: this.subscriber\n        };\n      });\n    }\n\n    _setup(client, sub) {\n      client.setMaxListeners(0);\n      return new this.Promise((resolve, reject) => {\n        client.on(\"error\", e => {\n          return this.Events.trigger(\"error\", e);\n        });\n\n        if (sub) {\n          client.on(\"message\", (channel, message) => {\n            var ref;\n            return (ref = this.limiters[channel]) != null ? ref._store.onMessage(channel, message) : void 0;\n          });\n        }\n\n        if (client.status === \"ready\") {\n          return resolve();\n        } else {\n          return client.once(\"ready\", resolve);\n        }\n      });\n    }\n\n    _loadScripts() {\n      return Scripts.names.forEach(name => {\n        return this.client.defineCommand(name, {\n          lua: Scripts.payload(name)\n        });\n      });\n    }\n\n    __runCommand__(cmd) {\n      var _this = this;\n\n      return _asyncToGenerator(function* () {\n        var _, deleted;\n\n        yield _this.ready;\n\n        var _ref = yield _this.client.pipeline([cmd]).exec();\n\n        var _ref2 = _slicedToArray(_ref, 1);\n\n        var _ref2$ = _slicedToArray(_ref2[0], 2);\n\n        _ = _ref2$[0];\n        deleted = _ref2$[1];\n        return deleted;\n      })();\n    }\n\n    __addLimiter__(instance) {\n      return this.Promise.all([instance.channel(), instance.channel_client()].map(channel => {\n        return new this.Promise((resolve, reject) => {\n          return this.subscriber.subscribe(channel, () => {\n            this.limiters[channel] = instance;\n            return resolve();\n          });\n        });\n      }));\n    }\n\n    __removeLimiter__(instance) {\n      var _this2 = this;\n\n      return [instance.channel(), instance.channel_client()].forEach(\n      /*#__PURE__*/\n      function () {\n        var _ref3 = _asyncToGenerator(function* (channel) {\n          if (!_this2.terminated) {\n            yield _this2.subscriber.unsubscribe(channel);\n          }\n\n          return delete _this2.limiters[channel];\n        });\n\n        return function (_x) {\n          return _ref3.apply(this, arguments);\n        };\n      }());\n    }\n\n    __scriptArgs__(name, id, args, cb) {\n      var keys;\n      keys = Scripts.keys(name, id);\n      return [keys.length].concat(keys, args, cb);\n    }\n\n    __scriptFn__(name) {\n      return this.client[name].bind(this.client);\n    }\n\n    disconnect(flush = true) {\n      var i, k, len, ref;\n      ref = Object.keys(this.limiters);\n\n      for (i = 0, len = ref.length; i < len; i++) {\n        k = ref[i];\n        clearInterval(this.limiters[k]._store.heartbeat);\n      }\n\n      this.limiters = {};\n      this.terminated = true;\n\n      if (flush) {\n        return this.Promise.all([this.client.quit(), this.subscriber.quit()]);\n      } else {\n        this.client.disconnect();\n        this.subscriber.disconnect();\n        return this.Promise.resolve();\n      }\n    }\n\n  }\n\n  ;\n  IORedisConnection.prototype.datastore = \"ioredis\";\n  IORedisConnection.prototype.defaults = {\n    Redis: null,\n    clientOptions: {},\n    clusterNodes: null,\n    client: null,\n    Promise: Promise,\n    Events: null\n  };\n  return IORedisConnection;\n}.call(void 0);\n\nmodule.exports = IORedisConnection;"]},"metadata":{},"sourceType":"script"}