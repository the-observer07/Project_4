{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/regenerator/index.js\");\n\nvar _classCallCheck = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\n\nvar _createClass = require(\"/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/@babel/runtime/helpers/createClass.js\").default;\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {\n  try {\n    var info = gen[key](arg);\n    var value = info.value;\n  } catch (error) {\n    reject(error);\n    return;\n  }\n\n  if (info.done) {\n    resolve(value);\n  } else {\n    Promise.resolve(value).then(_next, _throw);\n  }\n}\n\nfunction _asyncToGenerator(fn) {\n  return function () {\n    var self = this,\n        args = arguments;\n    return new Promise(function (resolve, reject) {\n      var gen = fn.apply(self, args);\n\n      function _next(value) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value);\n      }\n\n      function _throw(err) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err);\n      }\n\n      _next(undefined);\n    });\n  };\n}\n\nvar Events, RedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nScripts = require(\"./Scripts\");\n\nRedisConnection = function () {\n  var RedisConnection = /*#__PURE__*/function () {\n    function RedisConnection() {\n      var _this3 = this;\n\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      _classCallCheck(this, RedisConnection);\n\n      parser.load(options, this.defaults, this);\n\n      if (this.Redis == null) {\n        this.Redis = eval(\"require\")(\"redis\"); // Obfuscated or else Webpack/Angular will try to inline the optional redis module. To override this behavior: pass the redis module to Bottleneck as the 'Redis' option.\n      }\n\n      if (this.Events == null) {\n        this.Events = new Events(this);\n      }\n\n      this.terminated = false;\n\n      if (this.client == null) {\n        this.client = this.Redis.createClient(this.clientOptions);\n      }\n\n      this.subscriber = this.client.duplicate();\n      this.limiters = {};\n      this.shas = {};\n      this.ready = this.Promise.all([this._setup(this.client, false), this._setup(this.subscriber, true)]).then(function () {\n        return _this3._loadScripts();\n      }).then(function () {\n        return {\n          client: _this3.client,\n          subscriber: _this3.subscriber\n        };\n      });\n    }\n\n    _createClass(RedisConnection, [{\n      key: \"_setup\",\n      value: function _setup(client, sub) {\n        var _this4 = this;\n\n        client.setMaxListeners(0);\n        return new this.Promise(function (resolve, reject) {\n          client.on(\"error\", function (e) {\n            return _this4.Events.trigger(\"error\", e);\n          });\n\n          if (sub) {\n            client.on(\"message\", function (channel, message) {\n              var ref;\n              return (ref = _this4.limiters[channel]) != null ? ref._store.onMessage(channel, message) : void 0;\n            });\n          }\n\n          if (client.ready) {\n            return resolve();\n          } else {\n            return client.once(\"ready\", resolve);\n          }\n        });\n      }\n    }, {\n      key: \"_loadScript\",\n      value: function _loadScript(name) {\n        var _this5 = this;\n\n        return new this.Promise(function (resolve, reject) {\n          var payload;\n          payload = Scripts.payload(name);\n          return _this5.client.multi([[\"script\", \"load\", payload]]).exec(function (err, replies) {\n            if (err != null) {\n              return reject(err);\n            }\n\n            _this5.shas[name] = replies[0];\n            return resolve(replies[0]);\n          });\n        });\n      }\n    }, {\n      key: \"_loadScripts\",\n      value: function _loadScripts() {\n        var _this6 = this;\n\n        return this.Promise.all(Scripts.names.map(function (k) {\n          return _this6._loadScript(k);\n        }));\n      }\n    }, {\n      key: \"__runCommand__\",\n      value: function __runCommand__(cmd) {\n        var _this = this;\n\n        return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  _context.next = 2;\n                  return _this.ready;\n\n                case 2:\n                  return _context.abrupt(\"return\", new _this.Promise(function (resolve, reject) {\n                    return _this.client.multi([cmd]).exec_atomic(function (err, replies) {\n                      if (err != null) {\n                        return reject(err);\n                      } else {\n                        return resolve(replies[0]);\n                      }\n                    });\n                  }));\n\n                case 3:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        }))();\n      }\n    }, {\n      key: \"__addLimiter__\",\n      value: function __addLimiter__(instance) {\n        var _this7 = this;\n\n        return this.Promise.all([instance.channel(), instance.channel_client()].map(function (channel) {\n          return new _this7.Promise(function (resolve, reject) {\n            var _handler;\n\n            _handler = function handler(chan) {\n              if (chan === channel) {\n                _this7.subscriber.removeListener(\"subscribe\", _handler);\n\n                _this7.limiters[channel] = instance;\n                return resolve();\n              }\n            };\n\n            _this7.subscriber.on(\"subscribe\", _handler);\n\n            return _this7.subscriber.subscribe(channel);\n          });\n        }));\n      }\n    }, {\n      key: \"__removeLimiter__\",\n      value: function __removeLimiter__(instance) {\n        var _this2 = this;\n\n        return this.Promise.all([instance.channel(), instance.channel_client()].map( /*#__PURE__*/function () {\n          var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(channel) {\n            return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n              while (1) {\n                switch (_context2.prev = _context2.next) {\n                  case 0:\n                    if (_this2.terminated) {\n                      _context2.next = 3;\n                      break;\n                    }\n\n                    _context2.next = 3;\n                    return new _this2.Promise(function (resolve, reject) {\n                      return _this2.subscriber.unsubscribe(channel, function (err, chan) {\n                        if (err != null) {\n                          return reject(err);\n                        }\n\n                        if (chan === channel) {\n                          return resolve();\n                        }\n                      });\n                    });\n\n                  case 3:\n                    return _context2.abrupt(\"return\", delete _this2.limiters[channel]);\n\n                  case 4:\n                  case \"end\":\n                    return _context2.stop();\n                }\n              }\n            }, _callee2);\n          }));\n\n          return function (_x) {\n            return _ref.apply(this, arguments);\n          };\n        }()));\n      }\n    }, {\n      key: \"__scriptArgs__\",\n      value: function __scriptArgs__(name, id, args, cb) {\n        var keys;\n        keys = Scripts.keys(name, id);\n        return [this.shas[name], keys.length].concat(keys, args, cb);\n      }\n    }, {\n      key: \"__scriptFn__\",\n      value: function __scriptFn__(name) {\n        return this.client.evalsha.bind(this.client);\n      }\n    }, {\n      key: \"disconnect\",\n      value: function disconnect() {\n        var flush = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n        var i, k, len, ref;\n        ref = Object.keys(this.limiters);\n\n        for (i = 0, len = ref.length; i < len; i++) {\n          k = ref[i];\n          clearInterval(this.limiters[k]._store.heartbeat);\n        }\n\n        this.limiters = {};\n        this.terminated = true;\n        this.client.end(flush);\n        this.subscriber.end(flush);\n        return this.Promise.resolve();\n      }\n    }]);\n\n    return RedisConnection;\n  }();\n\n  ;\n  RedisConnection.prototype.datastore = \"redis\";\n  RedisConnection.prototype.defaults = {\n    Redis: null,\n    clientOptions: {},\n    client: null,\n    Promise: Promise,\n    Events: null\n  };\n  return RedisConnection;\n}.call(void 0);\n\nmodule.exports = RedisConnection;","map":{"version":3,"sources":["/Users/inspireadmin/Documents/GitHub/Project_2/node_modules/bottleneck/lib/RedisConnection.js"],"names":["asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","err","undefined","Events","RedisConnection","Scripts","parser","require","options","load","defaults","Redis","eval","terminated","client","createClient","clientOptions","subscriber","duplicate","limiters","shas","ready","all","_setup","_loadScripts","sub","setMaxListeners","on","e","trigger","channel","message","ref","_store","onMessage","once","name","payload","multi","exec","replies","names","map","k","_loadScript","cmd","_this","exec_atomic","instance","channel_client","handler","chan","removeListener","subscribe","_this2","_ref","unsubscribe","_x","id","cb","keys","length","concat","evalsha","bind","flush","i","len","Object","clearInterval","heartbeat","end","prototype","datastore","call","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nvar Events, RedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nScripts = require(\"./Scripts\");\n\nRedisConnection = function () {\n  class RedisConnection {\n    constructor(options = {}) {\n      parser.load(options, this.defaults, this);\n\n      if (this.Redis == null) {\n        this.Redis = eval(\"require\")(\"redis\"); // Obfuscated or else Webpack/Angular will try to inline the optional redis module. To override this behavior: pass the redis module to Bottleneck as the 'Redis' option.\n      }\n\n      if (this.Events == null) {\n        this.Events = new Events(this);\n      }\n\n      this.terminated = false;\n\n      if (this.client == null) {\n        this.client = this.Redis.createClient(this.clientOptions);\n      }\n\n      this.subscriber = this.client.duplicate();\n      this.limiters = {};\n      this.shas = {};\n      this.ready = this.Promise.all([this._setup(this.client, false), this._setup(this.subscriber, true)]).then(() => {\n        return this._loadScripts();\n      }).then(() => {\n        return {\n          client: this.client,\n          subscriber: this.subscriber\n        };\n      });\n    }\n\n    _setup(client, sub) {\n      client.setMaxListeners(0);\n      return new this.Promise((resolve, reject) => {\n        client.on(\"error\", e => {\n          return this.Events.trigger(\"error\", e);\n        });\n\n        if (sub) {\n          client.on(\"message\", (channel, message) => {\n            var ref;\n            return (ref = this.limiters[channel]) != null ? ref._store.onMessage(channel, message) : void 0;\n          });\n        }\n\n        if (client.ready) {\n          return resolve();\n        } else {\n          return client.once(\"ready\", resolve);\n        }\n      });\n    }\n\n    _loadScript(name) {\n      return new this.Promise((resolve, reject) => {\n        var payload;\n        payload = Scripts.payload(name);\n        return this.client.multi([[\"script\", \"load\", payload]]).exec((err, replies) => {\n          if (err != null) {\n            return reject(err);\n          }\n\n          this.shas[name] = replies[0];\n          return resolve(replies[0]);\n        });\n      });\n    }\n\n    _loadScripts() {\n      return this.Promise.all(Scripts.names.map(k => {\n        return this._loadScript(k);\n      }));\n    }\n\n    __runCommand__(cmd) {\n      var _this = this;\n\n      return _asyncToGenerator(function* () {\n        yield _this.ready;\n        return new _this.Promise((resolve, reject) => {\n          return _this.client.multi([cmd]).exec_atomic(function (err, replies) {\n            if (err != null) {\n              return reject(err);\n            } else {\n              return resolve(replies[0]);\n            }\n          });\n        });\n      })();\n    }\n\n    __addLimiter__(instance) {\n      return this.Promise.all([instance.channel(), instance.channel_client()].map(channel => {\n        return new this.Promise((resolve, reject) => {\n          var handler;\n\n          handler = chan => {\n            if (chan === channel) {\n              this.subscriber.removeListener(\"subscribe\", handler);\n              this.limiters[channel] = instance;\n              return resolve();\n            }\n          };\n\n          this.subscriber.on(\"subscribe\", handler);\n          return this.subscriber.subscribe(channel);\n        });\n      }));\n    }\n\n    __removeLimiter__(instance) {\n      var _this2 = this;\n\n      return this.Promise.all([instance.channel(), instance.channel_client()].map(\n      /*#__PURE__*/\n      function () {\n        var _ref = _asyncToGenerator(function* (channel) {\n          if (!_this2.terminated) {\n            yield new _this2.Promise((resolve, reject) => {\n              return _this2.subscriber.unsubscribe(channel, function (err, chan) {\n                if (err != null) {\n                  return reject(err);\n                }\n\n                if (chan === channel) {\n                  return resolve();\n                }\n              });\n            });\n          }\n\n          return delete _this2.limiters[channel];\n        });\n\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }()));\n    }\n\n    __scriptArgs__(name, id, args, cb) {\n      var keys;\n      keys = Scripts.keys(name, id);\n      return [this.shas[name], keys.length].concat(keys, args, cb);\n    }\n\n    __scriptFn__(name) {\n      return this.client.evalsha.bind(this.client);\n    }\n\n    disconnect(flush = true) {\n      var i, k, len, ref;\n      ref = Object.keys(this.limiters);\n\n      for (i = 0, len = ref.length; i < len; i++) {\n        k = ref[i];\n        clearInterval(this.limiters[k]._store.heartbeat);\n      }\n\n      this.limiters = {};\n      this.terminated = true;\n      this.client.end(flush);\n      this.subscriber.end(flush);\n      return this.Promise.resolve();\n    }\n\n  }\n\n  ;\n  RedisConnection.prototype.datastore = \"redis\";\n  RedisConnection.prototype.defaults = {\n    Redis: null,\n    clientOptions: {},\n    client: null,\n    Promise: Promise,\n    Events: null\n  };\n  return RedisConnection;\n}.call(void 0);\n\nmodule.exports = RedisConnection;"]},"metadata":{},"sourceType":"script"}